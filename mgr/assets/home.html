<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGA 帖子管理</title>
    <style>
        body {
            background-color: #f0f8ff;
            font-family: Arial, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        h2 {
            margin: 5px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
            text-align: left;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #ddd;
        }

        button {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .delete-button {
            background-color: #f44336;
        }

        .delete-button:hover {
            background-color: #e53935;
        }

        .update-button {
            background-color: #ff9800;
        }

        .update-button:hover {
            background-color: #fb8c00;
        }

        .hidden {
            display: none;
        }

        .inline {
            display: inline-block;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div id="tokenSection" class="hidden">
        <h2 class="inline">设置Token</h2>
        <input type="text" id="authToken" placeholder="Authorization Token">
        <button onclick="setAuthToken()">设置</button>
    </div>
    <h2 class="inline">创建帖子</h2>
    <input type="number" id="createId" placeholder="帖子 ID">
    <button onclick="createTopic()">创建</button>
    <h2>帖子列表</h2>
    <div id="topics"></div>
    <script>
        const baseUrl = window.location.origin;
        const headers = {};
        const inputToken = document.getElementById('authToken');

        function setAuthToken() {
            const token = inputToken.value;
            if (token && token.trim() !== '') {
                headers.Authorization = `${token}`;
                localStorage.setItem('token', token);
            }
            listTopics();
        }

        function loadAuthToken() {
            const token = localStorage.getItem('token');
            if (token) {
                inputToken.value = token;
                headers.Authorization = token;
                showTokenSection();
            }
        }

        function showTokenSection() {
            document.getElementById('tokenSection').classList.remove('hidden');
        }

        async function fetchTopics() {
            const response = await fetch(`${baseUrl}/topic`, { headers });
            if (response.status === 401) {
                showTokenSection();
                throw new Error('需要设置 Token');
            }
            if (!response.ok) {
                throw new Error('Failed to fetch topics');
            }
            return response.json();
        }

        function renderTopics(topics) {
            const topicsDiv = document.getElementById('topics');
            let table = '<table><tr><th>ID</th><th>标题</th><th>楼主</th><th>定时任务</th><th>操作</th></tr>';
            topics.forEach(topic => {
                table += `<tr>
                    <td>${topic.Id}</td>
                    <td>${topic.Title}</td>
                    <td>${topic.Author}</td>
                    <td>${topic.Metadata.UpdateCron}</td>
                    <td>
                        <button onclick="viewTopic(${topic.Id})">查看</button>
                        <button class="update-button" onclick="updateTopic(${topic.Id})">更新</button>
                        <button class="delete-button" onclick="deleteTopic(${topic.Id})">删除</button>
                    </td>
                </tr>`;
            });
            table += '</table>';
            topicsDiv.innerHTML = table;
        }

        async function listTopics() {
            try {
                const topics = await fetchTopics();
                renderTopics(topics);
            } catch (error) {
                alert(error.message);
            }
        }

        async function createTopic() {
            const id = document.getElementById('createId').value;
            if (!id) {
                alert('请输入帖子 ID');
                return;
            }
            try {
                const response = await fetch(`${baseUrl}/topic/${id}`, { method: 'PUT', headers });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error);
                }
                alert(`帖子 ${data} 创建成功`);
                listTopics();
            } catch (error) {
                alert(error.message);
            }
        }

        async function deleteTopic(id) {
            if (confirm(`确认要删除帖子 ${id} ?`)) {
                try {
                    const response = await fetch(`${baseUrl}/topic/${id}`, { method: 'DELETE', headers });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error);
                    }
                    alert(`删除帖子 ${data} 成功`);
                    listTopics();
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        async function updateTopic(id) {
            const cron = prompt("输入任务定时公式:", "@every 1h");
            if (cron && cron.trim() !== '') {
                try {
                    const response = await fetch(`${baseUrl}/topic/${id}`, {
                        method: 'POST',
                        headers: { ...headers, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ UpdateCron: cron })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error);
                    }
                    alert(`更新帖子 ${data} 成功`);
                    listTopics();
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        function viewTopic(id) {
            window.open(`${baseUrl}/view/${id}`, '_blank');
        }

        window.addEventListener('load', () => {
            loadAuthToken();
            listTopics();
        });
    </script>
</body>

</html>